// ========================================
// TP STATISTIQUE SPATIALE EXPLORATOIRE
// Analyse du Burkina Faso avec GEE
// ========================================

// CONFIGURATION INITIALE
Map.setCenter(-1.5, 12.3, 7);

// ========================================
// 1. CHARGEMENT DES LIMITES ADMINISTRATIVES GADM
// ========================================
print('=== LIMITES ADMINISTRATIVES GADM ===');

// Charger vos assets GADM
var gadm0 = ee.FeatureCollection('projects/tp1-indiv-visualisation/assets/gadm41_BFA_0');
var gadm1 = ee.FeatureCollection('projects/tp1-indiv-visualisation/assets/gadm41_BFA_1');
var gadm2 = ee.FeatureCollection('projects/tp1-indiv-visualisation/assets/gadm41_BFA_2');
var gadm3 = ee.FeatureCollection('projects/tp1-indiv-visualisation/assets/gadm41_BFA_3');

// Caract√©ristiques des limites administratives
print('üìä CARACT√âRISTIQUES DES LIMITES:');
print('Niveau 0 (Pays) - Nombre de features:', gadm0.size());
print('Niveau 0 - Propri√©t√©s:', gadm0.first().propertyNames());
print('Niveau 0 - Premier √©l√©ment:', gadm0.first());
print('---');

print('Niveau 1 (R√©gions) - Nombre:', gadm1.size());
print('Niveau 1 - Propri√©t√©s:', gadm1.first().propertyNames());
print('Niveau 1 - Noms des r√©gions:', gadm1.aggregate_array('NAME_1'));
print('---');

print('Niveau 2 (Provinces) - Nombre:', gadm2.size());
print('Niveau 2 - Propri√©t√©s:', gadm2.first().propertyNames());
print('---');

print('Niveau 3 (D√©partements) - Nombre:', gadm3.size());
print('Niveau 3 - Propri√©t√©s:', gadm3.first().propertyNames());
print('---');

// Calculer les superficies
var gadm1WithArea = gadm1.map(function(feat) {
  return feat.set('area_km2', feat.geometry().area().divide(1000000));
});
print('Superficie des r√©gions (km¬≤):', gadm1WithArea.aggregate_array('area_km2'));

// ========================================
// 2. CHARGEMENT DES DONN√âES WORLDPOP (2015-2025)
// ========================================
print('=== DONN√âES DE POPULATION (WORLDPOP) ===');

// Fonction pour charger vos rasters WorldPop
var loadPopRaster = function(year) {
  var assetPath = 'projects/tp1-indiv-visualisation/assets/bfa_pop_' + 
                  year + '_CN_100m_R2025A_v1';
  return ee.Image(assetPath).set('year', year);
};

// Cr√©er une collection avec tous les rasters de population
var years = [2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025];
var popImages = years.map(loadPopRaster);
var popCollection = ee.ImageCollection(popImages);

print('Nombre d\'images de population:', popCollection.size());
print('Ann√©es disponibles:', years);

// Caract√©ristiques du premier raster
var pop2015 = loadPopRaster(2015);
print('Propri√©t√©s raster 2015:', pop2015.propertyNames());
print('Projection:', pop2015.projection());
print('√âchelle (m):', pop2015.projection().nominalScale());

// Statistiques globales pour chaque ann√©e
print('üìä STATISTIQUES DE POPULATION PAR ANN√âE:');

// Calculer uniquement pour quelques ann√©es cl√©s pour √©viter trop d'agr√©gations
var keyYears = [2015, 2020, 2025];
var popStatsKey = keyYears.map(function(year) {
  var img = loadPopRaster(year);
  var stats = img.reduceRegion({
    reducer: ee.Reducer.sum(),
    geometry: gadm0.geometry(),
    scale: 500, // √âchelle r√©duite pour acc√©l√©rer
    maxPixels: 1e10,
    bestEffort: true
  });
  
  return ee.Feature(null, {
    'year': year,
    'sum': stats.get('b1')
  });
});

var popStats = ee.FeatureCollection(popStatsKey);
print('Statistiques pour ann√©es cl√©s (2015, 2020, 2025):', popStats);

// Taux de croissance
print('Calcul du taux de croissance en cours...');
var pop2015img = loadPopRaster(2015);
var pop2025img = loadPopRaster(2025);

var stats2015 = pop2015img.reduceRegion({
  reducer: ee.Reducer.sum(),
  geometry: gadm0.geometry(),
  scale: 500,
  maxPixels: 1e10,
  bestEffort: true
});

var stats2025 = pop2025img.reduceRegion({
  reducer: ee.Reducer.sum(),
  geometry: gadm0.geometry(),
  scale: 500,
  maxPixels: 1e10,
  bestEffort: true
});

var pop2015Total = ee.Number(stats2015.get('b1'));
var pop2025Total = ee.Number(stats2025.get('b1'));
var growthRate = pop2025Total.subtract(pop2015Total).divide(pop2015Total).multiply(100);

// √âvaluer le r√©sultat
growthRate.evaluate(function(result) {
  print('Taux de croissance 2015-2025 (%):', result);
});

// ========================================
// 3. CHARGEMENT DES INFRASTRUCTURES (OPTIONNEL)
// ========================================
print('=== INFRASTRUCTURES ===');

// V√©rifier si les infrastructures existent
var hasInfrastructures = false;
var cities, villages, schools, hospitals;

try {
  cities = ee.FeatureCollection('projects/tp1-indiv-visualisation/assets/cities_100');
  villages = ee.FeatureCollection('projects/tp1-indiv-visualisation/assets/villages_100');
  schools = ee.FeatureCollection('projects/tp1-indiv-visualisation/assets/schools_100');
  hospitals = ee.FeatureCollection('projects/tp1-indiv-visualisation/assets/hospitals_100');
  hasInfrastructures = true;
  
  // Caract√©ristiques des infrastructures
  print('üìä CARACT√âRISTIQUES DES INFRASTRUCTURES:');
  print('Villes - Nombre:', cities.size());
  print('Villes - Propri√©t√©s:', cities.first().propertyNames());
  print('Villes - √âchantillon:', cities.limit(3));
  print('---');
  
  print('Villages - Nombre:', villages.size());
  print('Villages - Propri√©t√©s:', villages.first().propertyNames());
  print('---');
  
  print('√âcoles - Nombre:', schools.size());
  print('√âcoles - Propri√©t√©s:', schools.first().propertyNames());
  print('---');
  
  print('H√¥pitaux - Nombre:', hospitals.size());
  print('H√¥pitaux - Propri√©t√©s:', hospitals.first().propertyNames());
  print('---');
} catch(e) {
  print('‚ö†Ô∏è Assets d\'infrastructures non trouv√©s.');
  print('‚ö†Ô∏è Les visualisations d\'infrastructures seront ignor√©es.');
  print('‚ö†Ô∏è Assurez-vous d\'avoir upload√©: cities_100, villages_100, schools_100, hospitals_100');
}

// ========================================
// 4. VISUALISATIONS AVANC√âES
// ========================================

var emptyImg = ee.Image().byte();

// 4.1 LIMITES ADMINISTRATIVES - VUE HI√âRARCHIQUE
print('=== CARTES DES LIMITES ADMINISTRATIVES ===');

// Niveau 0 - Fronti√®re nationale (rouge √©pais)
var gadm0Outline = emptyImg.paint({
  featureCollection: gadm0,
  color: 1,
  width: 5
});
Map.addLayer(gadm0Outline, {palette: 'FF0000'}, 'üó∫Ô∏è Fronti√®re Nationale (Niveau 0)', true);

// Niveau 1 - R√©gions avec remplissage color√©
// Cr√©er un ID num√©rique pour chaque r√©gion
var gadm1WithID = gadm1.map(function(feat, idx) {
  return feat.set('region_id', idx);
});

var gadm1Filled = emptyImg.paint(gadm1WithID, 'region_id');
Map.addLayer(gadm1Filled, {
  palette: ['#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00', 
            '#ffff33', '#a65628', '#f781bf', '#66c2a5', '#fc8d62', 
            '#8da0cb', '#e78ac3', '#a6d854'],
  min: 0,
  max: 12
}, 'üó∫Ô∏è R√©gions (Niveau 1)', true);

// Niveau 1 - Contours
var gadm1Outline = emptyImg.paint({
  featureCollection: gadm1,
  color: 1,
  width: 3
});
Map.addLayer(gadm1Outline, {palette: '000000'}, 'Contours R√©gions', true);

// Niveau 2 - Provinces
var gadm2Outline = emptyImg.paint({
  featureCollection: gadm2,
  color: 1,
  width: 1.5
});
Map.addLayer(gadm2Outline, {palette: 'FFA500'}, 'üó∫Ô∏è Provinces (Niveau 2)', false);

// Niveau 3 - D√©partements
var gadm3Outline = emptyImg.paint({
  featureCollection: gadm3,
  color: 1,
  width: 0.8
});
Map.addLayer(gadm3Outline, {palette: 'FFFF00'}, 'üó∫Ô∏è D√©partements (Niveau 3)', false);

// 4.2 POPULATION 2025 - CARTE DE DENSIT√â
print('=== CARTES DE POPULATION ===');

var pop2025 = loadPopRaster(2025);
var popVis = {
  min: 0,
  max: 500,
  palette: ['#ffffff', '#fff5f0', '#fee0d2', '#fcbba1', '#fc9272', 
            '#fb6a4a', '#ef3b2c', '#cb181d', '#a50f15', '#67000d']
};
Map.addLayer(pop2025, popVis, 'üë• Densit√© Population 2025', true);

// 4.3 CARTE CHOROPL√àTHE - POPULATION PAR R√âGION
var popByRegion = pop2025.reduceRegions({
  collection: gadm1,
  reducer: ee.Reducer.sum(),
  scale: 500, // √âchelle augment√©e pour r√©duire les calculs
  crs: 'EPSG:4326',
  tileScale: 4 // Parall√©lisation pour acc√©l√©rer
});

print('Population par r√©gion (limit√©e √† 5):', popByRegion.limit(5));

// Visualisation choropl√®the
var maxPopRegion = ee.Number(popByRegion.aggregate_max('sum'));
var minPopRegion = ee.Number(popByRegion.aggregate_min('sum'));

var choropleth = popByRegion.map(function(feat) {
  var value = ee.Number(feat.get('sum'));
  var normalized = value.subtract(minPopRegion)
    .divide(maxPopRegion.subtract(minPopRegion));
  return feat.set('pop_normalized', normalized);
});

var choroplethImg = emptyImg.paint(choropleth, 'pop_normalized');
Map.addLayer(choroplethImg, {
  palette: ['#ffffcc', '#ffeda0', '#fed976', '#feb24c', 
            '#fd8d3c', '#fc4e2a', '#e31a1c', '#bd0026', '#800026'],
  min: 0,
  max: 1
}, 'üìä Population par R√©gion (Choropl√®the)', false);

// 4.4 √âVOLUTION TEMPORELLE - GRAPHIQUE
// Cr√©er un graphique simple avec les ann√©es cl√©s
var chartPop = ui.Chart.feature.byFeature({
  features: popStats,
  xProperty: 'year',
  yProperties: ['sum']
}).setSeriesNames(['Population Totale'])
  .setOptions({
  title: '√âvolution de la Population (2015, 2020, 2025)',
  hAxis: {title: 'Ann√©e', format: '####'},
  vAxis: {title: 'Population Totale', format: 'short'},
  lineWidth: 3,
  pointSize: 6,
  series: {
    0: {color: '#1f77b4'}
  }
});
print(chartPop);

// 4.5 COMPARAISON 2015 vs 2025
var pop2015 = loadPopRaster(2015);
var popDiff = pop2025.subtract(pop2015);

Map.addLayer(popDiff, {
  min: -100,
  max: 100,
  palette: ['#d73027', '#fc8d59', '#fee090', '#ffffbf', 
            '#e0f3f8', '#91bfdb', '#4575b4']
}, 'üìà Changement Population (2025-2015)', false);

// 4.6 HOTSPOTS DE POPULATION
var kernel = ee.Kernel.gaussian({
  radius: 10000,
  units: 'meters',
  normalize: true
});

var popDensity = pop2025.convolve(kernel);
Map.addLayer(popDensity, {
  min: 0,
  max: 2000,
  palette: ['#440154', '#31688e', '#35b779', '#fde724']
}, 'üî• Hotspots Population', false);

// 4.7 INFRASTRUCTURES - VISUALISATION (SI DISPONIBLES)
print('=== CARTES DES INFRASTRUCTURES ===');

if (hasInfrastructures) {
  // Villes (grandes)
  Map.addLayer(cities, {color: 'red'}, 'üèôÔ∏è Villes', true);
  
  // Villages (moyennes)
  Map.addLayer(villages, {color: 'orange'}, 'üèòÔ∏è Villages', false);
  
  // √âcoles
  Map.addLayer(schools, {color: 'blue'}, 'üè´ √âcoles', true);
  
  // H√¥pitaux
  Map.addLayer(hospitals, {color: 'green'}, 'üè• H√¥pitaux', true);
  
  // 4.8 DENSIT√â D'INFRASTRUCTURES
  var schoolsCount = schools.size();
  var hospitalsCount = hospitals.size();
  print('Total √©coles:', schoolsCount);
  print('Total h√¥pitaux:', hospitalsCount);
  
  // 4.9 ACCESSIBILIT√â - DISTANCE AUX H√îPITAUX
  // Cr√©er une image avec une valeur constante pour chaque h√¥pital
  var hospitalsImg = ee.Image(0).byte().paint({
    featureCollection: hospitals,
    color: 1
  });
  
  var distance = hospitalsImg.fastDistanceTransform({
    neighborhood: 256,
    units: 'pixels',
    metric: 'squared_euclidean'
  }).sqrt()
    .multiply(ee.Image.pixelArea().sqrt());
  
  Map.addLayer(distance.clip(gadm0), {
    min: 0,
    max: 50000,
    palette: ['green', 'yellow', 'orange', 'red']
  }, 'üöë Distance aux H√¥pitaux (m)', false);
  
  // 4.10 RATIO POPULATION/INFRASTRUCTURES PAR R√âGION
  var gadm1Stats = gadm1.map(function(region) {
    var regionPop = pop2025.reduceRegion({
      reducer: ee.Reducer.sum(),
      geometry: region.geometry(),
      scale: 100,
      maxPixels: 1e10
    }).get('b1');
    
    var schoolCount = schools.filterBounds(region.geometry()).size();
    var hospitalCount = hospitals.filterBounds(region.geometry()).size();
    
    return region.set({
      'population': regionPop,
      'schools': schoolCount,
      'hospitals': hospitalCount,
      'pop_per_school': ee.Number(regionPop).divide(ee.Number(schoolCount).max(1)),
      'pop_per_hospital': ee.Number(regionPop).divide(ee.Number(hospitalCount).max(1))
    });
  });
  
  print('üìä Ratio Population/Infrastructures par r√©gion:', gadm1Stats);
} else {
  print('‚ö†Ô∏è Visualisations d\'infrastructures ignor√©es (assets manquants)');
}

// 4.11 GRADIENT DE POPULATION
var gradient = pop2025.gradient();
var gradientMagnitude = gradient.select('x').pow(2)
  .add(gradient.select('y').pow(2)).sqrt();

Map.addLayer(gradientMagnitude, {
  min: 0,
  max: 50,
  palette: ['white', 'yellow', 'orange', 'red', 'darkred']
}, 'üìê Gradient de Densit√©', false);

// ========================================
// 5. STATISTIQUES AVANC√âES
// ========================================
print('=== ANALYSES STATISTIQUES AVANC√âES ===');

// Statistiques par niveau administratif
var pop2025ByProvince = pop2025.reduceRegions({
  collection: gadm2,
  reducer: ee.Reducer.sum(),
  scale: 500,
  tileScale: 4
});

print('Top 5 provinces par population:', 
  pop2025ByProvince.sort('sum', false).limit(5));

// Histogramme de distribution
var histogram = ui.Chart.image.histogram({
  image: pop2025,
  region: gadm0.geometry(),
  scale: 1000, // √âchelle augment√©e
  maxPixels: 1e8, // R√©duit
  maxBuckets: 30 // R√©duit
}).setOptions({
  title: 'Distribution de la Densit√© de Population (2025)',
  hAxis: {title: 'Densit√© (personnes/100m¬≤)', format: 'short'},
  vAxis: {title: 'Fr√©quence (pixels)', format: 'short'},
  colors: ['#1f77b4'],
  legend: {position: 'none'}
});
print(histogram);

// ========================================
// 6. L√âGENDE INTERACTIVE
// ========================================

var legend = ui.Panel({
  style: {
    position: 'bottom-left',
    padding: '8px 15px',
    backgroundColor: 'white'
  }
});

var legendTitle = ui.Label({
  value: 'üìä Densit√© de Population',
  style: {
    fontWeight: 'bold',
    fontSize: '16px',
    margin: '0 0 8px 0',
    padding: '0'
  }
});
legend.add(legendTitle);

var makeRow = function(color, name) {
  var colorBox = ui.Label({
    style: {
      backgroundColor: color,
      padding: '10px',
      margin: '0 0 4px 0',
      border: '1px solid black'
    }
  });
  var description = ui.Label({
    value: name,
    style: {margin: '0 0 4px 6px'}
  });
  return ui.Panel({
    widgets: [colorBox, description],
    layout: ui.Panel.Layout.Flow('horizontal')
  });
};

legend.add(makeRow('#ffffff', '0 - Tr√®s faible'));
legend.add(makeRow('#fcbba1', '100 - Faible'));
legend.add(makeRow('#fb6a4a', '200 - Moyenne'));
legend.add(makeRow('#cb181d', '300 - √âlev√©e'));
legend.add(makeRow('#67000d', '500+ - Tr√®s √©lev√©e'));

Map.add(legend);

// ========================================
// 7. EXPORTS (OPTIONNELS)
// ========================================
print('=== OPTIONS D\'EXPORT ===');

// D√©commentez pour exporter
/*
// Export population 2025
Export.image.toDrive({
  image: pop2025,
  description: 'BFA_Population_2025',
  scale: 100,
  region: gadm0.geometry(),
  maxPixels: 1e10
});

// Export statistiques r√©gionales
Export.table.toDrive({
  collection: popByRegion,
  description: 'BFA_Stats_Regions',
  fileFormat: 'CSV'
});

// Export ratio infrastructures
Export.table.toDrive({
  collection: gadm1Stats,
  description: 'BFA_Ratio_Infrastructures',
  fileFormat: 'CSV'
});
*/

// ========================================
// 8. R√âSUM√â FINAL
// ========================================
print('===========================================');
print('‚úÖ SCRIPT TERMIN√â AVEC SUCC√àS');
print('===========================================');
print('üìç Toutes les couches sont charg√©es sur la carte');
print('üìä Consultez les graphiques et statistiques ci-dessus');
print('üó∫Ô∏è Utilisez les cases √† cocher pour activer/d√©sactiver les couches');
print('üíæ D√©commentez la section Export pour sauvegarder les r√©sultats');
print('===========================================');